---
title: "Upload Biomarker and Longitudinal (BAL) data to REDCap system"
date: "January 3, 2025"
date-modified: today
author: "Jonathan M. Reader"
abstract: "The following is a protocol for uploading biomarker and longitudinal data returned from the National Alzheimer’s Coordinating Center (NACC) into the REDCap system."
format: html
---

## TO DO

-   Play with Markdown settings

-   Create script to be a set of functions in the `madRc` package/executablev

-   Create Example

-   Upload REDCap fields/Zip to project

## Pre-work potentially required

The variable names provided by the National Alzheimer’s Coordinating Center (NACC) may not match the existing fields in your REDCap project when uploading the data for the first time. As a result, corresponding variables must be created in REDCap before the upload can proceed. Keep in mind that not all NACC variables are needed locally, and any unneeded fields are excluded in the upload script by commenting them out.

The REDCap form is organized as a repeating form with the variable "Sample" identifying if the data are for ABeta40, ABeta42, or pTau217. For us, this required enabling repeating instruments and events and setting each event (i.e., visit) to have BAL Data Returned by NACC as an individually repeating form, independent of the other forms in the event. We also added the custom label, `[bal_sample]` to easily see which sample the form corresponded to.

The following included Zip File contains the REDCap Form used by the MADC: "BALDataReturnedByNAC_2025-01-03_0854.zip".

You will have to update variable names to match your instance of REDCap for this script to work.

## Extract

A link to BAL data will be provided to those on a list by NACC. Those data can be downloaded using the password provided in a separate email from NACC to this folder; all XLSX files are included in the `.gitignore` file.

```{r}
#| label: Setup
#| echo: true
#| message: false
#| warning: false

# install.packages("tidyverse") # If not installed, install tidyverse for data munging
# install.packages("readxl") # If not installed, install readxl to get BAL data
# install.packages("RCurl") # If not installed, install RCurl for API to REDCap
# install.packages("tidylog") # If not installed, install tidylog for support
library(tidyverse)
library(readxl)
library(RCurl)
library(tidylog)
```

```{r}
#| label: Extract
#| echo: true
#| message: false
#| warning: false

df_ab40 <- read_xlsx("Site 43 AB40 BAL0008 Return 11.xlsx")
df_ab42 <- read_xlsx("Site 43 AB42 BAL0008 Return 11.xlsx")
df_ptau217 <- read_xlsx("Site 43 pTau217 BAL0008 Return 11.xlsx")
df_nfl_gfap <- read_xlsx("Site 43 N2PB BAL0008 Return 11.xlsx")

# The below function downloads data from the MADC's UMMAP General REDCap project which contains the forms and fields needed for matching and uploading into the correct project. Your group will have a different project where this information is stored.

# If obtaining the fields is of interest, please see XXXXXX

download_ummap_general_data <- function(config = "~/Dropbox (University of Michigan)/config copy.R"){ # update to where your configuration file is located
  # The config file needs to contain the REDCAP_API_URI and REDCAP_API_TOKEN_UMMAPGENERAL variables as strings where the URI is the URI and the TOKEN is your API TOKEN, respectively
  source(config)
  ummapgen <- postForm(
    uri=REDCAP_API_URI,
    token=REDCAP_API_TOKEN_UMMAPGENERAL,
    content='record',
    format='csv',
    type='flat',
    rawOrLabel='raw',
    rawOrLabelHeaders='raw',
    exportCheckboxLabel='false',
    exportSurveyFields='false',
    exportDataAccessGroups='false',
    returnFormat='csv'
  )
  df_ummapgen <<- read_csv(ummapgen, col_types = cols(.default = col_character()))
}

download_ummap_general_data()
```

## Transform

Some variable manipulation is required to put into the REDCap format created in the `Pre-work` step.

```{r}
#| label: Transform
#| echo: true
#| message: false
#| warning: false

df_ummapgen_t <- df_ummapgen %>% 
  select(
    subject_id,
    redcap_event_name, # Need this for matching correct event for upload
    date_of_draw
  ) %>% 
  mutate(date_of_draw = as.Date(date_of_draw)) # For merging with data from NACC

df_ab40_t <- df_ab40 %>% 
  mutate(bal_sample = "ABeta40", # Needed for repeating form identification upload to REDCap
         redcap_event_name = NA_character_, # Needed for upload to longitudinal REDCap project
         redcap_repeat_instrument = "bal_data_returned_by_nacc", # Needed for upload to repeating form project
         redcap_repeat_instance = 1, # Needed for repeating form identification upload to REDCap
         bal_data_returned_by_nacc_complete = 2, # Needed to mark form complete
         `Collection Date` = as.Date(`Collection Date`, format = "%m/%d/%Y")) %>% # Needed for date format upload to REDCap 
  left_join(df_ummapgen_t, by = c("PT ID" = "subject_id", "Collection Date" = "date_of_draw")) %>% 
  select( # Select and rename in the same step
    # `ADRC Site`
    subject_id = `PT ID`,
    redcap_event_name = redcap_event_name.y, # .y to get from df_ummapgen_t
    redcap_repeat_instrument,
    redcap_repeat_instance,
    bal_sample,
    bal_barcode = `Barcode`,
    bal_kit_number = `Kit Number`,
    bal_collection_date = `Collection Date`,
    bal_specimen_quantity = `Specimen Quantity`,
    # `Unit of Measure`
    # `LAB_ID`
    # `Lab_Study_ID`,
    bal_analysis_date = `Analysis Date`,
    # `INST_ID`
    # `Assay_Platform`
    # `Assay_Name`
    bal_assay_lot_no = `Assay_Lot_No.`,
    bal_data_pg_ml = `ABeta40 Data (pg/mL)`,
    bal_lab_freeze_thaw = `Lab Freeze Thaw`,
    bal_flagged_biomarkers = `Flagged Biomarkers`,
    bal_additional_information = `Additional Information`,
    bal_data_returned_by_nacc_complete
  )

df_ab42_t <- df_ab42 %>% 
  mutate(bal_sample = "ABeta42", # Needed for repeating form identification upload to REDCap
         redcap_event_name = NA_character_, # Needed for upload to longitudinal REDCap project
         redcap_repeat_instrument = "bal_data_returned_by_nacc", # Needed for upload to repeating form project
         redcap_repeat_instance = 2, # Needed for repeating form identification upload to REDCap
         bal_data_returned_by_nacc_complete = 2, # Needed to mark form complete
         `Collection Date` = as.Date(`Collection Date`, format = "%m/%d/%Y")) %>% # Needed for date format upload to REDCap 
  left_join(df_ummapgen_t, by = c("PT ID" = "subject_id", "Collection Date" = "date_of_draw")) %>%
  select( # Select and rename in the same step
    # `ADRC Site`
    subject_id = `PT ID`,
    redcap_event_name = redcap_event_name.y, # .y to get from df_ummapgen_t
    redcap_repeat_instrument,
    redcap_repeat_instance,
    bal_sample,
    bal_barcode = `Barcode`,
    bal_kit_number = `Kit Number`,
    bal_collection_date = `Collection Date`,
    bal_specimen_quantity = `Specimen Quantity`,
    # `Unit of Measure`
    # `LAB_ID`
    # `Lab_Study_ID`,
    bal_analysis_date = `Analysis Date`,
    # `INST_ID`
    # `Assay_Platform`
    # `Assay_Name`
    bal_assay_lot_no = `Assay_Lot_No.`,
    bal_data_pg_ml = `ABeta42 Data (pg/mL)`,
    bal_lab_freeze_thaw = `Lab Freeze Thaw`,
    bal_flagged_biomarkers = `Flagged Biomarkers`,
    bal_additional_information = `Additional Information`,
    bal_data_returned_by_nacc_complete
  )

df_ptau217_t <- df_ptau217 %>% 
  mutate(bal_sample = "pTau217", # Needed for repeating form identification upload to REDCap
         redcap_event_name = NA_character_, # Needed for upload to longitudinal REDCap project
         redcap_repeat_instrument = "bal_data_returned_by_nacc", # Needed for upload to repeating form project
         redcap_repeat_instance = 3, # Needed for repeating form identification upload to REDCap
         bal_data_returned_by_nacc_complete = 2, # Needed to mark form complete
         `Collection Date` = as.Date(`Collection Date`, format = "%m/%d/%Y")) %>% # Needed for date format upload to REDCap 
  left_join(df_ummapgen_t, by = c("PT ID" = "subject_id", "Collection Date" = "date_of_draw")) %>%
  select( # Select and rename in the same step
    # `ADRC Site`
    subject_id = `PT ID`,
    redcap_event_name = redcap_event_name.y, # .y to get from df_ummapgen_t
    redcap_repeat_instrument,
    redcap_repeat_instance,
    bal_sample,
    bal_barcode = `Barcode`,
    bal_kit_number = `Kit Number`,
    bal_collection_date = `Collection Date`,
    bal_specimen_quantity = `Specimen Quantity`,
    # `Unit of Measure`
    # `LAB_ID`
    # `Lab_Study_ID`,
    bal_analysis_date = `Analysis Date`,
    # `INST_ID`
    # `Assay_Platform`
    # `Assay_Name`
    bal_assay_lot_no = `Assay_Lot_No.`,
    bal_data_pg_ml = `pTau217 Conc (pg/mL)`,
    bal_lab_freeze_thaw = `Lab Freeze Thaw`,
    bal_flagged_biomarkers = `Flagged Biomarkers`,
    bal_additional_information = `Additional Information`,
    bal_data_returned_by_nacc_complete
  )

df_nfl_t <- df_nfl_gfap %>% 
  mutate(bal_sample = "NfL", # Needed for repeating form identification upload to REDCap
         redcap_event_name = NA_character_, # Needed for upload to longitudinal REDCap project
         redcap_repeat_instrument = "bal_data_returned_by_nacc", # Needed for upload to repeating form project
         redcap_repeat_instance = 4, # Needed for repeating form identification upload to REDCap
         bal_data_returned_by_nacc_complete = 2, # Needed to mark form complete
         `Collection Date` = as.Date(`Collection Date`, format = "%m/%d/%Y")) %>% # Needed for date format upload to REDCap 
  left_join(df_ummapgen_t, by = c("PT ID" = "subject_id", "Collection Date" = "date_of_draw")) %>%
  select( # Select and rename in the same step
    # `ADRC Site`
    subject_id = `PT ID`,
    redcap_event_name = redcap_event_name.y, # .y to get from df_ummapgen_t
    redcap_repeat_instrument,
    redcap_repeat_instance,
    bal_sample,
    bal_barcode = `Barcode`,
    bal_kit_number = `Kit Number`,
    bal_collection_date = `Collection Date`,
    bal_specimen_quantity = `Specimen Quantity`,
    # `Unit of Measure`
    # `LAB_ID`
    # `Lab_Study_ID`,
    bal_analysis_date = `Analysis Date`,
    # `INST_ID`
    # `Assay_Platform`
    # `Assay_Name`
    bal_assay_lot_no = `Assay_Lot_No.`,
    bal_data_pg_ml = `NFL Conc (pg/mL)`,
    bal_lab_freeze_thaw = `Lab Freeze Thaw`,
    bal_flagged_biomarkers = `Flagged Biomarkers`,
    bal_additional_information = `Additional Information`,
    bal_data_returned_by_nacc_complete
  )

df_gfap_t <- df_nfl_gfap %>% 
  mutate(bal_sample = "GFAP", # Needed for repeating form identification upload to REDCap
         redcap_event_name = NA_character_, # Needed for upload to longitudinal REDCap project
         redcap_repeat_instrument = "bal_data_returned_by_nacc", # Needed for upload to repeating form project
         redcap_repeat_instance = 5, # Needed for repeating form identification upload to REDCap
         bal_data_returned_by_nacc_complete = 2, # Needed to mark form complete
         `Collection Date` = as.Date(`Collection Date`, format = "%m/%d/%Y")) %>% # Needed for date format upload to REDCap 
  left_join(df_ummapgen_t, by = c("PT ID" = "subject_id", "Collection Date" = "date_of_draw")) %>%
  select( # Select and rename in the same step
    # `ADRC Site`
    subject_id = `PT ID`,
    redcap_event_name = redcap_event_name.y, # .y to get from df_ummapgen_t
    redcap_repeat_instrument,
    redcap_repeat_instance,
    bal_sample,
    bal_barcode = `Barcode`,
    bal_kit_number = `Kit Number`,
    bal_collection_date = `Collection Date`,
    bal_specimen_quantity = `Specimen Quantity`,
    # `Unit of Measure`
    # `LAB_ID`
    # `Lab_Study_ID`,
    bal_analysis_date = `Analysis Date`,
    # `INST_ID`
    # `Assay_Platform`
    # `Assay_Name`
    bal_assay_lot_no = `Assay_Lot_No.`,
    bal_data_pg_ml = `GFAP Conc (pg/mL)`,
    bal_lab_freeze_thaw = `Lab Freeze Thaw`,
    bal_flagged_biomarkers = `Flagged Biomarkers`,
    bal_additional_information = `Additional Information`,
    bal_data_returned_by_nacc_complete
  )
```

## Audit Collection Date from NACC versus REDCap

Any IDs without a `redcap_event_name` indicate a mismatched Collection Date and need to be reconciled. This step can be skipped once all IDs are reconciled.

```{r}
#| label: Audit
#| echo: true
#| message: false
#| warning: false

df_ab40_a <- df_ab40_t %>% 
  filter(is.na(redcap_event_name))

df_ab42_a <- df_ab42_t %>% 
  filter(is.na(redcap_event_name))

df_ptau217_a <- df_ptau217_t %>% 
  filter(is.na(redcap_event_name))

df_nfl_a <- df_nfl_t %>% 
  filter(is.na(redcap_event_name))

df_gfap_a <- df_gfap_t %>% 
  filter(is.na(redcap_event_name))
```

## Quick Fix

Some files may need to be manually corrected due to conflict in the blood draw date in General compared to the blood draw date of the BAL. This should be reviewed every upload (e.g., visit_04_arm_1, baseline_arm_1).

```{r}
df_ab40_t2 <- df_ab40_t %>% 
  mutate(redcap_event_name = case_when(
    subject_id == "UM00001731" ~ "visit_03_arm_1",
    subject_id == "UM00003215" ~ "visit_01_arm_1",
    subject_id == "UM00001529" ~ "visit_05_arm_1",
    subject_id == "UM00001869" ~ "visit_02_arm_1",
    subject_id == "UM00001640" ~ "visit_05_arm_1",
    subject_id == "UM00002188" ~ "visit_01_arm_1",
    subject_id == "UM00003414" ~ "baseline_arm_1",
    TRUE ~ redcap_event_name
  ))

df_ab42_t2 <- df_ab42_t %>% 
  mutate(redcap_event_name = case_when(
    subject_id == "UM00001731" ~ "visit_03_arm_1",
    subject_id == "UM00003215" ~ "visit_01_arm_1",
    subject_id == "UM00001529" ~ "visit_05_arm_1",
    subject_id == "UM00001869" ~ "visit_02_arm_1",
    subject_id == "UM00001640" ~ "visit_05_arm_1",
    subject_id == "UM00002188" ~ "visit_01_arm_1",
    subject_id == "UM00003414" ~ "baseline_arm_1",
    TRUE ~ redcap_event_name
  ))

df_ptau217_t2 <- df_ptau217_t %>% 
  mutate(redcap_event_name = case_when(
    subject_id == "UM00001731" ~ "visit_03_arm_1",
    subject_id == "UM00003215" ~ "visit_01_arm_1",
    subject_id == "UM00001529" ~ "visit_05_arm_1",
    subject_id == "UM00001869" ~ "visit_02_arm_1",
    subject_id == "UM00001640" ~ "visit_05_arm_1",
    subject_id == "UM00002188" ~ "visit_01_arm_1",
    subject_id == "UM00003414" ~ "baseline_arm_1",
    TRUE ~ redcap_event_name
  ))

df_nfl_t2 <- df_nfl_t %>% 
  mutate(redcap_event_name = case_when(
    subject_id == "UM00001731" ~ "visit_03_arm_1",
    subject_id == "UM00003215" ~ "visit_01_arm_1",
    subject_id == "UM00001529" ~ "visit_05_arm_1",
    subject_id == "UM00001869" ~ "visit_02_arm_1",
    subject_id == "UM00001640" ~ "visit_05_arm_1",
    subject_id == "UM00002188" ~ "visit_01_arm_1",
    subject_id == "UM00003414" ~ "baseline_arm_1",
    TRUE ~ redcap_event_name
  ))

df_gfap_t2 <- df_gfap_t %>% 
  mutate(redcap_event_name = case_when(
    subject_id == "UM00001731" ~ "visit_03_arm_1",
    subject_id == "UM00003215" ~ "visit_01_arm_1",
    subject_id == "UM00001529" ~ "visit_05_arm_1",
    subject_id == "UM00001869" ~ "visit_02_arm_1",
    subject_id == "UM00001640" ~ "visit_05_arm_1",
    subject_id == "UM00002188" ~ "visit_01_arm_1",
    subject_id == "UM00003414" ~ "baseline_arm_1",
    TRUE ~ redcap_event_name
  ))
```

## Load

Now that the data are transformed into an acceptable form for REDCap, they can be uploaded either by API or manual import via the web interface.

All csv files are included in the `.gitignore` file (i.e., \*.csv).

```{r}
#| label: Load
#| echo: true
#| message: false
#| warning: false

write_csv(df_ab40_t2, str_c(today(), " BAL ABeta40 from NACC Upload.csv")) # Attach date of upload to transformed file
write_csv(df_ab42_t2, str_c(today(), " BAL ABeta42 from NACC Upload.csv")) # Attach date of upload to transformed file
write_csv(df_ptau217_t2, str_c(today(), " BAL pTau217 from NACC Upload.csv")) # Attach date of upload to transformed file
write_csv(df_nfl_t2, str_c(today(), " BAL NfL from NACC Upload.csv")) # Attach date of upload to transformed file
write_csv(df_gfap_t2, str_c(today(), " BAL GFAP from NACC Upload.csv")) # Attach date of upload to transformed file

# api_upload <- str_c(read_lines("file.csv"), collapse = "\n")
# 
# return <- RCurl::postForm(
#   uri=REDCAP_API_URI,
#   token=REDCAP_API_TOKEN_UMMAPGENERAL,
#   content='record',
#   format='csv',
#   type='flat',
#   overwriteBehavior='normal',
#   # fields=upload_fields,
#   data=api_upload
# )
```
